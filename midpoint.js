document.addEventListener('DOMContentLoaded',function(){const dismissButton=document.querySelector('.dismiss-widget');dismissButton.addEventListener('click',()=>{const floatingWidget=document.querySelector('.routing-floating-widget');if(floatingWidget){floatingWidget.style.display='none'}})});document.addEventListener('DOMContentLoaded',function(){const findMidpointBtn=document.getElementById('find-midpoint-btn');const routingWidget=document.querySelector('.routing-floating-widget');findMidpointBtn.addEventListener('click',function(){routingWidget.style.display='block'})});let originMarker,destinationMarker,userLocLayer;function locateUser(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition((position)=>{const{latitude,longitude}=position.coords;const coordinates=ol.proj.transform([longitude,latitude],'EPSG:4326','EPSG:3857');console.log('Current location coordinates:',coordinates);const view=map.getView();view.setCenter(coordinates);view.setZoom(17);const userLoc=new ol.Feature({geometry:new ol.geom.Point(coordinates)});const nominatimUrl=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;$.getJSON(nominatimUrl,(data)=>{if(data.address){const originInput=document.getElementById("origin");originInput.value=data.display_name;const newOrigin=new ol.Feature({geometry:new ol.geom.Point(coordinates)});if(!originMarker){originMarker=new ol.layer.Vector({name:'Origin Marker',source:new ol.source.Vector({features:[newOrigin]}),style:new ol.style.Style({image:new ol.style.Icon({src:'https://cdn-icons-png.flaticon.com/24/6819/6819077.png',})})});map.addLayer(originMarker);console.log('Origin marker:',originMarker)}else{originMarker.getSource().clear();originMarker.getSource().addFeature(newOrigin)}}})},()=>{alert('Unable to locate your position')})}else{alert('Geolocation is not supported by this browser')}}
function initGpsButton(){const gpsButton=document.getElementById('gps');gpsButton.addEventListener('click',_.debounce(function(){gpsButton.style.color="#1E3050";locateUser()},1000,{leading:!0,trailing:!1}))}
function debounce(func,wait){let timeout;return function(){const context=this,args=arguments;clearTimeout(timeout);timeout=setTimeout(()=>func.apply(context,args),wait)}}
const cache={};const fetchSuggestions=debounce((input,dropdown)=>{const query=input.value.trim();if(query.length<3){dropdown.innerHTML='';dropdown.style.display='none';return}
if(cache[query]){displaySuggestions(cache[query],dropdown,input);return}
const nominatimUrl=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&q=${encodeURIComponent(query)}`;$.getJSON(nominatimUrl,(data)=>{if(data.length>0){cache[query]=data;displaySuggestions(data,dropdown,input)}})},300);function displaySuggestions(data,dropdown,input){const items=data.map((item)=>`<li style="padding: 5px 10px; cursor: pointer;" data-lat="${item.lat}" data-lon="${item.lon}">${item.display_name}</li>`).join('');dropdown.innerHTML=`<ul style="margin: 0; padding: 0; list-style: none;">${items}</ul>`;dropdown.style.display='block';dropdown.querySelectorAll('li').forEach((item)=>{item.addEventListener('click',()=>{const lat=parseFloat(item.getAttribute('data-lat'));const lon=parseFloat(item.getAttribute('data-lon'));console.log(`Latitude: ${lat}, Longitude: ${lon}`);const coordinates=ol.proj.fromLonLat([lon,lat]);const view=map.getView();view.setCenter(coordinates);view.setZoom(17);input.value=item.textContent;dropdown.style.display='none'})})}
$(document).ready(function(){initGpsButton();const originInput=document.getElementById('origin');const originDropdown=document.getElementById('origin-dropdown');const destinationInput=document.getElementById('destination');const destinationDropdown=document.getElementById('destination-dropdown');const routeButton=document.getElementById('route');originInput.addEventListener('keyup',()=>{fetchSuggestions(originInput,originDropdown)});destinationInput.addEventListener('keyup',()=>{fetchSuggestions(destinationInput,destinationDropdown)})});map.on('singleclick',function(evt){const clickedCoord=evt.coordinate;const clickedCoord4326=ol.proj.transform(clickedCoord,'EPSG:3857','EPSG:4326');const rippleFeature=new ol.Feature({geometry:new ol.geom.Circle(clickedCoord,0)});const rippleStyle=new ol.style.Style({stroke:new ol.style.Stroke({color:'rgba(0, 0, 255, 0.5)',width:2})});const rippleLayer=new ol.layer.Vector({name:'Ripple Layer',source:new ol.source.Vector({features:[rippleFeature]}),style:rippleStyle});map.addLayer(rippleLayer);let radius=0;const animate=function(){radius+=1;rippleFeature.getGeometry().setRadius(radius);if(radius<20){requestAnimationFrame(animate)}else{map.removeLayer(rippleLayer)}};animate();const nominatimUrl=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${clickedCoord4326[1]}&lon=${clickedCoord4326[0]}`;$.getJSON(nominatimUrl,(data)=>{if(data.address){const originInput=document.getElementById('origin');const destinationInput=document.getElementById('destination');if(originInput.value.trim()===''){originInput.value=data.display_name;const newOrigin=new ol.Feature({geometry:new ol.geom.Point(clickedCoord)});if(!originMarker){originMarker=new ol.layer.Vector({name:'Origin Marker',source:new ol.source.Vector({features:[newOrigin]}),style:new ol.style.Style({image:new ol.style.Icon({src:'https://cdn-icons-png.flaticon.com/24/6819/6819077.png',})})});map.addLayer(originMarker);console.log('Origin marker:',originMarker)}else{originMarker.getSource().clear();originMarker.getSource().addFeature(newOrigin)}}else if(destinationInput.value.trim()===''){destinationInput.value=data.display_name;const newDestination=new ol.Feature({geometry:new ol.geom.Point(clickedCoord)});if(!destinationMarker){destinationMarker=new ol.layer.Vector({name:'Destination Marker',source:new ol.source.Vector({features:[newDestination]}),style:new ol.style.Style({image:new ol.style.Icon({src:'https://cdn-icons-png.flaticon.com/24/8142/8142678.png',})})});map.addLayer(destinationMarker);console.log('Destination marker:',destinationMarker)}else{destinationMarker.getSource().clear();destinationMarker.getSource().addFeature(newDestination)}}}})});let routeLayer=null;const originMarkerStyle=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,1],src:'https://cdn-icons-png.flaticon.com/24/6819/6819077.png'})});const destinationMarkerStyle=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,1],src:'https://cdn-icons-png.flaticon.com/24/8142/8142678.png'})});const originList=document.getElementById('origin-dropdown');const destinationList=document.getElementById('destination-dropdown');const routeButton=document.getElementById('routeButton');originList.addEventListener('click',(event)=>{const coordinates=[parseFloat(event.target.dataset.lon),parseFloat(event.target.dataset.lat)];addMarker(coordinates,'origin')});destinationList.addEventListener('click',(event)=>{const coordinates=[parseFloat(event.target.dataset.lon),parseFloat(event.target.dataset.lat)];addMarker(coordinates,'destination')});function addMarker(coordinates,type){const marker=new ol.Feature({type:type,geometry:new ol.geom.Point(ol.proj.fromLonLat(coordinates))});if(type==='origin'){if(originMarker){originMarker.getSource().clear()}
originMarker=new ol.layer.Vector({source:new ol.source.Vector({features:[marker]}),style:originMarkerStyle});map.addLayer(originMarker)}else if(type==='destination'){if(destinationMarker){destinationMarker.getSource().clear()}
destinationMarker=new ol.layer.Vector({source:new ol.source.Vector({features:[marker]}),style:destinationMarkerStyle});map.addLayer(destinationMarker)}}
let currentMode='driving';document.addEventListener('DOMContentLoaded',()=>{const routeButton=document.getElementById('routeButton');const modeButtons=document.querySelectorAll('.mode-button');modeButtons.forEach((button)=>{button.addEventListener('click',()=>{modeButtons.forEach((btn)=>btn.classList.remove('active'));button.classList.add('active');currentMode=button.getAttribute('data-mode')})});routeButton.addEventListener('click',getRoute)});routeButton.addEventListener('click',()=>{getRoute()});function getRoute(){if(!originMarker||!destinationMarker){alert('Please select both an origin and a destination');return}
const originCoord=ol.proj.toLonLat(originMarker.getSource().getFeatures()[0].getGeometry().getCoordinates());const destCoord=ol.proj.toLonLat(destinationMarker.getSource().getFeatures()[0].getGeometry().getCoordinates());const baseUrl=`https://router.project-osrm.org/route/v1/${currentMode}/${originCoord[0]},${originCoord[1]};${destCoord[0]},${destCoord[1]}?overview=full&geometries=geojson&steps=true`;fetch(baseUrl).then((response)=>{return response.json()}).then((data)=>{const route=data.routes[0].geometry;const routeCoords=route.coordinates.map((coord)=>{return ol.proj.fromLonLat(coord)});const routeFeature=new ol.Feature({type:'route',geometry:new ol.geom.LineString(routeCoords)});routeFeature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({width:6,color:'rgba(30, 144, 255, 0.8)',shadowColor:'rgba(30, 144, 255, 0.4)',shadowBlur:10})}));if(routeLayer){map.removeLayer(routeLayer)}
routeLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[routeFeature]})});map.addLayer(routeLayer);const distance=data.routes[0].distance/1000;document.getElementById('distance').innerHTML=`<i class="fa-solid fa-route"></i>&nbsp;&nbsp;Distance: ${distance.toFixed(2)} km`;const extent=routeLayer.getSource().getExtent();map.getView().fit(extent,{padding:[50,50,50,50],maxZoom:18,});const line=new ol.geom.LineString(routeCoords);const midPointCoord=line.getCoordinateAt(0.5);const midPointFeature=new ol.Feature({type:'midpoint',geometry:new ol.geom.Point(midPointCoord)});const midPointStyle=new ol.style.Style({image:new ol.style.Icon({src:'https://i.ibb.co/gWyRjHP/icons8-pin-96-xxhdpi.png',anchor:[0.5,1],anchorXUnits:'fraction',anchorYUnits:'fraction',scale:0.3})});midPointFeature.setStyle(midPointStyle);if(midpointLayer){map.removeLayer(midpointLayer)}
midpointLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[midPointFeature]})});map.addLayer(midpointLayer);const midPointWGS84=ol.proj.transform(midPointCoord,'EPSG:3857','EPSG:4326');const floatingWindow=document.getElementById('floating-window');floatingWindow.style.display='block';const cafeButton=document.getElementById('explore-cafes-btn');cafeButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'cafe')};const restaurantButton=document.getElementById('explore-restaurants-btn');restaurantButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'restaurant')};const barButton=document.getElementById('explore-bars-btn');barButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'bar')};const apartmentButton=document.getElementById('explore-apartments-btn');apartmentButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'apartment')};const hotelButton=document.getElementById('explore-hotels-btn');hotelButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'hotel')};const groceriesButton=document.getElementById('explore-groceries-btn');groceriesButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'groceries')};const parksButton=document.getElementById('explore-parks-btn');parksButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'parks')};const busStopsButton=document.getElementById('explore-busstops-btn');busStopsButton.onclick=function(){showMidpointOnGoogleMaps(midPointWGS84,'busstops')}}).catch((error)=>{console.log(error)})}
function showMidpointOnGoogleMaps(midPointWGS84,placeType){let query;if(placeType==='cafe'){query='Cafe Coffee'}else if(placeType==='restaurant'){query='Restaurant Food'}else if(placeType==='bar'||placeType==='bia'){query='Bar Brewpub'}else if(placeType==='apartment'){query='Apartment'}else if(placeType==='hotel'){query='hotel'}else if(placeType==='groceries'){query='Grocery store Supermarket'}else if(placeType==='parks'){query='Parks'}else if(placeType==='busstops'){query='Bus Stops'}else{query=''}
const googleMapsUrl=`https://www.google.com/maps/search/${query}/@${midPointWGS84[1]},${midPointWGS84[0]},17z/data=!3m1!4b1!4m7!2m6!3m5!1s${query}!2s${midPointWGS84[1]},${midPointWGS84[0]}!4m2!1d${midPointWGS84[0]}!2d${midPointWGS84[1]}!5m1!1e0!5m1!1e1?entry=ttu`;const googleMapsAppUrl=`https://www.google.com/maps/search/?api=1&query=${query}&center=${midPointWGS84[1]},${midPointWGS84[0]}&zoom=17`;const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);if(isMobile){window.open(googleMapsAppUrl,'_blank')}else{window.open(googleMapsUrl,'_blank')}
const gpsBtn=document.getElementById('gps');const clearOriginBtn=document.getElementById('clearOrigin');const originInput=document.getElementById('origin');const clearDestinationBtn=document.getElementById('clearDestination');const destinationInput=document.getElementById('destination');const clearrouteButton=document.getElementById('clearrouteButton');function toggleButtons(){if(originInput.value.trim()===''){gpsBtn.style.display='inline-block';clearOriginBtn.style.display='none'}else{gpsBtn.style.display='none';clearOriginBtn.style.display='inline-block'}}
toggleButtons();clearrouteButton.style.display='none';originInput.addEventListener('input',toggleButtons);gpsBtn.addEventListener('click',()=>{originInput.value='Current location';toggleButtons()});clearOriginBtn.addEventListener('click',()=>{originInput.value='';toggleButtons()});routeButton.addEventListener('click',()=>{routeButton.style.display='none';clearrouteButton.style.display='inline-block';getRoute()});let midpointLayer=null;clearrouteButton.addEventListener('click',()=>{if(originMarker){map.removeLayer(originMarker);originMarker=undefined}
if(destinationMarker){map.removeLayer(destinationMarker);destinationMarker=undefined}
if(routeLayer){map.removeLayer(routeLayer);routeLayer=null}
if(midpointLayer){map.removeLayer(midpointLayer);midpointLayer=null}
originInput.value='';destinationInput.value='';gpsBtn.style.display='inline-block';clearOriginBtn.style.display='none';clearDestinationBtn.style.display='none';routeButton.style.display='inline-block';clearrouteButton.style.display='none';const floatingWindow=document.getElementById('floating-window');floatingWindow.style.display='none';document.getElementById('distance').style.display='none';document.getElementById('explore-cafes-btn').style.display='inline-block';document.getElementById('explore-restaurants-btn').style.display='inline-block';document.getElementById('explore-bars-btn').style.display='inline-block';document.getElementById('explore-apartments-btn').style.display='inline-block';document.getElementById('explore-hotels-btn').style.display='inline-block';document.getElementById('explore-groceries-btn').style.display='inline-block';document.getElementById('explore-parks-btn').style.display='inline-block';document.getElementById('explore-busstops-btn').style.display='inline-block'});destinationInput.addEventListener('input',()=>{if(destinationInput.value.length>0){clearDestinationBtn.style.display='inline-block'}else{clearDestinationBtn.style.display='none'}});clearDestinationBtn.addEventListener('click',()=>{destinationInput.value='';clearDestinationBtn.style.display='none'});if(originMarker){map.removeLayer(originMarker);originMarker=undefined}
if(destinationMarker){map.removeLayer(destinationMarker);destinationMarker=undefined}
routeButton.addEventListener('click',()=>{routeButton.style.display='none';clearrouteButton.style.display='inline-block';document.getElementById('distance').style.display='flex';getRoute()})
